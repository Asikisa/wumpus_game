# Builds "Wumpus" game application

##############################################################################

# Directories of the game

ROOTDIR = ./
LIBAUDIO = $(ROOTDIR)3rdparty/audio/
LIBFLAGS = -L $(LIBAUDIO) -L /usr/local/lib/
LDFLAGS = -laudio -lbass

WDGDIR = $(ROOTDIR)gui/widgets/
ENTDIR = $(ROOTDIR)entities/
CFGDIR = $(ROOTDIR)settings/
CLIDIR = $(ROOTDIR)cli/
AIDIR  = $(ROOTDIR)ai/
GUIDIR = $(ROOTDIR)gui/
GUIHLP = $(GUIDIR)helpers/
FRMDIR = $(GUIDIR)forms/
HLPDIR = $(ENTDIR)helpers/
SCRDIR = $(ROOTDIR)scores/
MSCDIR = $(ROOTDIR)music/

VPATH = $(WDGDIR):$(CLIDIR):$(ENTDIR):$(CFGDIR):$(AIDIR):$(GUIDIR):\
				$(FRMDIR):$(HLPDIR):$(ENDDIR):$(GUIHLP):$(SCRDIR):$(MSCDIR)

##############################################################################

# Compiler settings

SRCFILES = $(wildcard *.cc)
CXX = g++
CXXFLAGS = -I $(ROOTDIR) $(LIBFLAGS) $(LDFLAGS) -ansi -pedantic -Wall -Wextra -std=c++14
CXXFLAGS += -MP -MD		# MD - only internal, MMD - with system
DBGFLAGS = -ggdb3 -DDEBUG -O0
RLSFLAGS = -O2
FLTKFLAGS = `fltk-config --use-images --ldflags`
OBJECTS = map.o subject.o enemy.o room.o player.o bat.o pit.o wump.o \
					guide.o level.o logic.o helpers.o cli_view.o \
					cli_controller.o ai_controller.o gui_view.o gui_controller.o \
					windows.o form_start.o form_help.o form_main.o widget_info.o \
					widget_map.o widget_netdraw.o widget_player.o trajectory.o \
					scores.o config.o images.o math_helpers.o music.o

##############################################################################

# Builds the game with OBJECTS

ifeq ($(MAKECMDGOALS), debug)
%.o : %.cc %.h
	$(CXX) $(CXXFLAGS) $(DBGFLAGS) -c $< -o $@
else
  ifeq ($(MAKECMDGOALS), test-debug)
  %.o : %.cc %.h
	  $(CXX) $(CXXFLAGS) $(DBGFLAGS) -c $< -o $@
  else
  %.o : %.cc %.h
	  $(CXX) $(CXXFLAGS) $(RLSFLAGS) -c $< -o $@
  endif
endif

wumpus : main.cc $(OBJECTS) 
	make -C $(LIBAUDIO)
	$(CXX) $(CXXFLAGS) $(RLSFLAGS) $< $(OBJECTS) $(FLTKFLAGS) $(LDFLAGS) -o $@

debug : main.cc $(OBJECTS)
	make debug -C $(LIBAUDIO)
	$(CXX) $(CXXFLAGS) $(DBGFLAGS) $< $(OBJECTS) $(FLTKFLAGS) $(LDFLAGS) -o wumpus_$@

test-release : $(OBJECTS)

test-debug : $(OBJECTS)

#############################################################################

# Includes dependicies files early generated by g++ with -MP -MMD opts

-include $(SRCFILES:%.cc=%.d)

# Cleans the garbage

clean :
	rm -rf gmon.out		# profiler out
	rm -f wumpus wumpus_debug *.d *.o
	make clean -C $(LIBAUDIO)